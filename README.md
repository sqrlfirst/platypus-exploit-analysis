# platypus-exploit-analysis

[![Foundry][foundry-badge]][foundry]

[foundry]: https://getfoundry.sh/
[foundry-badge]: https://img.shields.io/badge/Built%20with-Foundry-FFDB1C.svg

## Overview

That repo contains Platypus Finance smart contracts and fuzzing tests for Foundry framework to detect exploit that was used on 16 February 2023.


## PLATYPUS FINANCE Contracts

1. [MasterPlatypusV4](https://snowtrace.io/address/0x752cf5a9a9ef07018145522525242f9e8f3b41ea#code)
2. [Treasure](https://snowtrace.io/address/0xbcd6796177ab8071f6a9ba2c3e2e0301ee91bef5#code)


## Exploit description

The ```MasterPlatypusV4::emergencyWithdraw``` function performs its solvency check before updating the LP tokens associated with the stake position.

## Test to reproduce the attack

The ```Exploiter``` contract reproduce the attack by performing following operations:

1. FlashLoan from Aave.
2. Put USDC into the pool of Platypus.
3. Deposit LP into the MasterPlatypusV4.
4. Borrow USP.
5. call emergencyWithdraw to withdraw LP, while having *USP*.
6. Withdraw USDC by returning LP to the pool of Platypus.
7. Exchange USP to other stables.

to run test

```bash
forge test --contracts test/Exploiter.t.sol -vvv
```

## Invariant Description

in English:

__*The collateral used to back the borrowed funds cannot be withdrawn*__

The condition that is broken in contracts that actor will have non-zero USP balance, while his collateral is equal to zero.

in Solidity:

```solidity
    function invariant_withdrawBackingFunds() external {
        uint256 handlerBalance = USP.balanceOf(address(handler));
        PlatypusTreasure.PositionView memory Position = Treasure.positionView(address(handler), address(LPUSDC));
        uint256 limit = Position.borrowLimitUSP;

        assertEq(
            true,
            handlerBalance <= limit
        );
    }
```

to run invariant fuzzing

```bash
forge test --contracts test/Invariant.t.sol -vvv
```

## Sources

1. [Rekt article](https://rekt.news/platypus-finance-rekt/)
2. [platypus-finance/core](https://github.com/platypus-finance/core)
3. [Peckshield report](https://twitter.com/peckshield/status/1626367531480125440)
4. [Certik report](https://twitter.com/CertiKAlert/status/1626345374737727489)
